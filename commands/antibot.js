// commands/antibot.js
let antiBotEnabled = {};
let botStrikeCount = {}; // Compte les infractions par utilisateur

module.exports = {
  name: 'antibot',
  description: 'Supprime automatiquement les messages dÃ©tectÃ©s comme automatisÃ©s par des bots (on/off) + kick Ã  3 infractions',
  async execute({ client, message, args }) {
    try {
      if (!message.isGroup) {
        return client.sendMessage(message.from, { text: 'âŒ Cette commande fonctionne uniquement dans un groupe.' });
      }

      const groupMetadata = await client.groupMetadata(message.from);
      const participants = groupMetadata.participants;

      const isUserAdmin = participants.find(
        p => p.id === message.sender && (p.admin === 'admin' || p.admin === 'superadmin')
      );
      if (!isUserAdmin) {
        return client.sendMessage(message.from, { text: 'ğŸ”’ Seuls les administrateurs peuvent utiliser cette commande.' });
      }

      if (!args[0]) {
        return client.sendMessage(message.from, { text: 'Utilisation : *!antibot on* ou *!antibot off*' });
      }

      if (args[0] === 'on') {
        antiBotEnabled[message.from] = true;
        botStrikeCount[message.from] = {};
        client.sendMessage(message.from, { text: 'âœ… Anti-bot activÃ© pour ce groupe.' });
      } else if (args[0] === 'off') {
        antiBotEnabled[message.from] = false;
        botStrikeCount[message.from] = {};
        client.sendMessage(message.from, { text: 'âŒ Anti-bot dÃ©sactivÃ© pour ce groupe.' });
      }
    } catch (err) {
      console.error('Erreur antibot.js:', err);
      client.sendMessage(message.from, { text: 'âŒ Erreur lors de lâ€™activation/dÃ©sactivation de lâ€™anti-bot.' });
    }
  },

  async onMessage({ client, message }) {
    try {
      if (!message.isGroup || !antiBotEnabled[message.from]) return;

      // DÃ©tection basique de messages suspects (messages gÃ©nÃ©rÃ©s par bots)
      const text = message.body?.toLowerCase() || '';
      const probableBotPatterns = [
        'type !help', 'use /menu', 'generated by', 'ğŸ¤–', 'bot command', 'prefix !', 'prefix .'
      ];

      const isSuspectBot =
        probableBotPatterns.some(pattern => text.includes(pattern)) ||
        message.sender.includes('bot') || // Si le JID contient "bot"
        (message.message?.buttonsMessage || message.message?.listMessage); // Messages interactifs typiques de bots

      if (isSuspectBot) {
        await client.sendMessage(message.from, { delete: message.key });

        if (!botStrikeCount[message.from]) botStrikeCount[message.from] = {};
        if (!botStrikeCount[message.from][message.sender]) botStrikeCount[message.from][message.sender] = 0;
        botStrikeCount[message.from][message.sender]++;

        const infractions = botStrikeCount[message.from][message.sender];

        const botImage = 'https://files.catbox.moe/jvuqi0.jpg';
        let caption = `
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ ğŸ…¥ï¸ğŸ…ï¸ğŸ…œï¸ğŸ…Ÿï¸ğŸ…˜ï¸ğŸ…¡ï¸ğŸ…”ï¸  â“‚ï¸â’¹ï¸
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸŒğ•ğ„ğ‘ğ’ğˆğğ : *1.0*
ğŸ–Šï¸ğšƒğšˆğ™¿ğ™´ : ğ™¼ğ™¸ğ™½ğ™¸-ğ™±ğ™¾ğšƒ
ğŸŒ¹âƒâ”â® ğ“¹ğ“»ğ“¸ğ“¶ğ“¾ğ“½ ğ“¹ğ“ªğ“» ğ“³ğ“®ğ“·ğ“²ğ“¯ğ“®ğ“» ğ”ğ“¶
__________________________________
ğŸ¤– Bots interdits dÃ©tectÃ©s
ğŸ¥¹ Stop please (${infractions}/3)
__________________________________
`;

        await client.sendMessage(message.from, {
          image: { url: botImage },
          caption
        });

        if (infractions >= 3) {
          await client.groupParticipantsUpdate(message.from, [message.sender], 'remove');

          const kickCaption = `
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ ğŸ…¥ï¸ğŸ…ï¸ğŸ…œï¸ğŸ…Ÿï¸ğŸ…˜ï¸ğŸ…¡ï¸ğŸ…”ï¸  â“‚ï¸â’¹ï¸
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸŒğ•ğ„ğ‘ğ’ğˆğğ : *1.0*
ğŸ–Šï¸ğšƒğšˆğ™¿ğ™´ : ğ™¼ğ™¸ğ™½ğ™¸-ğ™±ğ™¾ğšƒ
ğŸŒ¹âƒâ”â® ğ“¹ğ“»ğ“¸ğ“¶ğ“¾ğ“½ ğ“¹ğ“ªğ“» ğ“³ğ“®ğ“·ğ“²ğ“¯ğ“®ğ“» ğ”ğ“¶
__________________________________
ğŸ’¢ @${message.sender.split('@')[0]} a Ã©tÃ© expulsÃ© pour spam de messages bot (3/3)
__________________________________
`;
          await client.sendMessage(message.from, {
            image: { url: botImage },
            caption: kickCaption,
            mentions: [message.sender]
          });
        }
      }
    } catch (err) {
      console.error('Erreur dÃ©tection antibot:', err);
    }
  }
};
